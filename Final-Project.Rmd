---
title: "<img src='figure/coursera.jpg' width='37'> <img src='figure/nyu.png' width='240'>"
subtitle: "<span style='color:white; background-color:#4E79A7;'>Overview of Advanced Methods of Reinforcement Learning in Finance</span> (Final Project)"
author: "[¬ÆŒ≥œÉ, Lian Hu](https://englianhu.github.io/) <img src='figure/quantitative trader 1.jpg' width='12'> <img src='figure/ENG.jpg' width='24'> ¬Æ"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    mathjax: https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    css: CSSBackgrounds.css
runtime: shiny
---

<br>
<span style='color:green'>**Theme Song**</span>
<br>

<audio src="music/NY-BJ-Dream.mp3" controls></audio>
<br>

<br><br>

------

## SCSS Setup

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r class.source = 'bg-success', class.output = 'bg-primary', message = FALSE, warning = FALSE}
# install.packages("remotes")
require('BBmisc')
#remotes::install_github("rstudio/sass")
lib('sass')
```

```{scss class.source = 'bg-success', class.output = 'bg-primary'}
/* https://stackoverflow.com/a/66029010/3806250 */
h1 { color: #002C54; }
h2 { color: #2F496E; }
h3 { color: #375E97; }

/* ----------------------------------------------------------------- */
/* https://gist.github.com/himynameisdave/c7a7ed14500d29e58149#file-broken-gradient-animation-less */
.hover-animate-background1 {
  /* color: #FFD64D; */
  background: linear-gradient(155deg, #EDAE01 0%, #FFEB94 100%);
  transition: all 0.45s;
  &:hover{
    background: linear-gradient(155deg, #EDAE01 20%, #FFEB94 80%);
    }
  }

/* //  For brevity, vendor prefixes have been removed. */
/* //  This does not work as expected; instead of a smooth transition */
/* //  what you get is a hard swap from one gradient to the next */
.hover-animate-background2 {
  color: #FFD64D;
  background: linear-gradient(155deg, #002C54 0%, #4CB5F5 100%);
  transition: all 0.45s;
  &:hover{
    background: linear-gradient(155deg, #002C54 20%, #4CB5F5 80%);
    }
  }
```

```{r global_options, class.source = 'bg-success', class.output = 'bg-primary'}
## https://stackoverflow.com/a/36846793/3806250
options(width = 999)
knitr::opts_chunk$set(class.source = 'hover-animate-background1', class.output = 'hover-animate-background2', class.error = 'bg-danger')
```

<br>

# ÂèóË¨õÁîü„Å´„Çà„Çã„ÉÜ„Çπ„ÉàÔºö(Final Project)

## Setup

```{r setup, warning = FALSE, message = FALSE}
if(!suppressPackageStartupMessages(require('BBmisc'))) {
  install.packages('BBmisc', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressPackageStartupMessages(require('BBmisc'))
# suppressPackageStartupMessages(require('rmsfuns'))

pkgs <- c('devtools', 'knitr', 'kableExtra', 'tidyr', 'sass', 
          'readr', 'lubridate', 'data.table', 'reprex', 
          'plyr', 'dplyr', 'stringr', 'magrittr', 'timetk', 
          'tidyverse', 'formattable', 'reticulate', 
          'echarts4r', 'paletteer', 'tidyquant', 'feaster', 
          'fable', 'fabletools', 'PerformanceAnalytics')

suppressAll(lib(pkgs))
# load_pkg(pkgs)

## Set the timezone but not change the datetime
Sys.setenv(TZ = 'Asia/Tokyo')
## options(knitr.table.format = 'html') will set all kableExtra tables to be 'html', otherwise need to set the parameter on every single table.
options(warn = -1, knitr.table.format = 'html')#, digits.secs = 6)

## https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-abnor-in-rmd-but-not-in-r-script
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, 
                      message = FALSE, cache.lazy = FALSE)
RdymEnable()
rm(pkgs)
```

<br><br>

# Introduction

ÂêàË®àÁÇπÊï∞ <span style='color:#3C5C; background-color:#011A27;'>60ÁÇπ</span>

<br>

## Ë™¨Êòé

This is a project that will be graded based on a peer-to-peer review. The project consists of four parts. The maximum score for each part is 10, so that maximum score you can give your peers (and they can give you) is 40. The parts are as follows (more detailed instructions are in specific cells below).

### Review criteria

- **Part 1**: Estimate the model using the DJI portfolio of 30 stocks, first without signals, and then using simple signals such as simple moving averages constructed below (Max 10 point).

- **Part 2**: Explore the implications of calibrated model parameters for default probabilities of stocks in your portfolio. Present your conclusions and observations. (Max 10 point).

- **Part 3**: Experiment with other signals and investigate the impact on model calibration obtained with alternative signals. Present your conclusions and observations. (Max 10 points).

- **Part 4**: Show me something else. This part is optional. Come up with your own idea of an interesting analysis. For example, you can repeat your analysis for the S&P portfolio. Or maybe you can build a strategy using an optimal market-implied policy estimated from this model, and compare it with PCA and absorption ratio strategies that we built in Course 2. Or anything else. (Max 10 points).

Files for this project

Files for this project are uploaded in the Notebook: [QED_DJI_calibration_Coursera_course_4.ipynb](https://hub.coursera-notebooks.org/user/instructorqhmgnnughhoz/notebooks/QED_DJI_calibration_Coursera_course_4.ipynb) and [dja_cap.csv](https://hub.coursera-notebooks.org/user/instructorqhmgnnughhoz/view/dja_cap.csv) ([dja_cap.csv](https://github.com/chandc/Inverse_Reinforcement_Learning_for_Stocks/blob/master/dja_cap.csv))

<br><br>

### Question

```{r, eval = FALSE, out.height = '600px', out.width = '400px', results = 'asis'}
xfun::file_string('QED_DJI_calibration_Coursera_course_4.html')

# htmltools::includeHTML('QED_DJI_calibration_Coursera_course_4.html')
htmltools::tags$iframe(title = 'Question Sheet', src = 'QED_DJI_calibration_Coursera_course_4.html', height = 600, width = '100%')
```

Kindly refer to [Include HTML files in R Markdown file?](https://stackoverflow.com/a/36525111/3806250) for more information.

```{r}
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
```

<br><br>

### Ëá™ÂàÜ„ÅÆÊèêÂá∫Áâ©

„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç *
„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´„Çè„Åã„Çä„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éà„É´„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ

- **Part 1**: Estimate the model using the DJI portfolio of 30 stocks, first without signals, and then using simple signals such as simple moving averages constructed below (*Max 10 point*).

- **Part 2**: Explore the implications of calibrated model parameters for default probabilities of stocks in your portfolio. Present your conclusions and observations. (*Max 10 point*).

- **Part 3**: Experiment with other signals and investigate the impact on model calibration obtained with alternative signals. Present your conclusions and observations. (*Max 10 points*).

- **Part 4**: Show me something else. This part is optional. Come up with your own idea of an interesting analysis. For example, you can repeat your analysis for the S&P portfolio. Or maybe you can build a strategy using an optimal market-implied policy estimated from this model, and compare it with PCA and absorption ratio strategies that we built in Course 2. Or anything else. (*Max 10 points*).

<br><br>

### „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥

<br><br>

## Answer

### Read Data

```{r read-data, warning = FALSE, message = FALSE}
if(!file.exists('./QED_DJI_calibration_Coursera_course_4.Rmd')) {
  ## https://rstudio-pubs-static.s3.amazonaws.com/31702_9c22e3d1a0c44968a4a1f9656f1800ab.html
  ## rmarkdown:::convert_ipynb('https://rlcquuio.labs.coursera.org/notebooks/QED_DJI_calibration_Coursera_course_4.ipynb')
  rmarkdown:::convert_ipynb('./QED_DJI_calibration_Coursera_course_4.ipynb')
  }

if(!file.exists('./data/dja_cap.csv')) {
  ## https://rstudio-pubs-static.s3.amazonaws.com/31702_9c22e3d1a0c44968a4a1f9656f1800ab.html
  ## https://github.com/chandc/Inverse_Reinforcement_Learning_for_Stocks/blob/master/dja_cap.csv
  ## https://rlcquuio.labs.coursera.org/view/dja_cap.csv', './data/dja_cap.csv
  utils::download.file('https://github.com/chandc/Inverse_Reinforcement_Learning_for_Stocks/blob/master/dja_cap.csv')
  }

dsmp <- fread('./data/dja_cap.csv')
```

[**Jupyter** - QED_DJI_calibration_Coursera_course_4](https://www.coursera.org/learn/advanced-methods-reinforcement-learning-finance/ungradedLab/FA2rG/final-project-exploration-of-non-linear-market-model-dynamics/lab)

[**Jupyter** - dja_cap.csv](https://rlcquuio.labs.coursera.org/view/dja_cap.csv)

- [Econometric estimation of an IRL-based market portfolio model](https://bailiping.github.io/2019-08-04-IRL/)
- [Econometric estimation of an IRL-based market portfolio model. Part II: QED](https://rlcquuio.labs.coursera.org/notebooks/QED_DJI_calibration_Coursera_course_4.ipynb)

### Part 1: Model calibration with or without moving average signals (Max 10 points)

To calibrate the model, it is convenient to use the log-prices instead of prices. Diffusion in the log-space 
$ y = \log x $ is given by the following Langevin equation:

$$
d y_t = - \frac{ \partial V(y)}{\partial y} dt + \sigma dW_t , \; \; \;  V(y)  \equiv - \left( \theta - \frac{\sigma^2}{2} + {\bf w} {\bf z}_t \right) y  + \kappa e^y + \frac{1}{2} g e^{2y}
$$

where $ W_t $ is a standard Brownian motion.
In terms of variables $ y = \log x $, the negative log-likelihood of data is therefore

$$
LL_M (\Theta) = - \log \prod_{t=0}^{T-1} 
\frac{1}{ \sqrt{ 2 \pi  \sigma^2}  } 
\exp \left\{  - \frac{1}{2 \sigma^2} \left(   \frac{ y_{t+ \Delta t} -   y_{t}}{ \Delta t} +  \frac{ \partial V(y)}{\partial y}   
\right)^2
\right\} , 
$$ 

where $ {\bf y}_t  = \log x_t $  now stands for observed values of log-cap. Note that because the model is Markov, the product over $ t = 0, \ldots, T-1 $ does not 
necessarily mean a product of transitions along the same trajectory. The negative log-likelihood should be minimized to estimate parameters $ 
\theta $, $ \sigma $, $ \kappa $, $ g $ and  $ {\bf w} $. You can try to estimate the model first without signals, then with signals.

```{python}
# Put the rest of you code and analysis for Part I here 
```

### Part 2: Analysis of default rates  (Max 10 point)

For a particle in a potential $ V(y) $ with a metastable minimum $ y = a $ and a barrier with a peak located at $ y = b $, the famous Kramers' escape formula gives the following expression for the escape rate $ r $ (see e.g. the book by van Kampen):

$$ 
r = \frac{\sqrt{ V''(a) \left| V''(b) \right| }}{2 \pi} \exp \left[ - \frac{2}{\sigma^2} (V(b) - V(a) ) \right]
$$

Here $ V''(a) $ and $ V''(b) $ stand for the second derivatives of the potential $ V(y) $ at the minimum and the maximum, respectively. This formula applies as long as the barrier height $ \Delta E \equiv  (V(b) - V(a) \gg \frac{\sigma^2}{2} $. 

Apply the Kramers formula to the QED potential and parameters that you found in your calibration. What range of values of $ r $ do you obtain? Do these values make sense to you? Can you think how you could use the Kramers relation as a way to regularize your MLE calibration?

```{python}
# Put the rest of your code and analysis for Part 2 here.
```

### Part 3: Propose and analyse your own signals  (Max 10 points)

In this part, you will experiment with other signals. Propose a signal and explain why it is interesting to 
include this signal in the portfolio analysis. Then add your favorite signal or signals to the previous benchmarck signals (or alternatively you can replace them), and repeat the analysis of model calibration. State your conclusions.

```{python}
# Put the rest of your code and analysis for Part 3 here.
```

### Part 4 (Optional): Show me something else (Max 10 points).

Here you can develop any additional analysis of the model that you may find interesting (One possible suggestion is 
presented above, but you should feel free to choose your own topic). Present your case and finding/conclusions.

```{python}
# Put the rest of your code and analysis for Part 3 here.
```


<br><br>

# Appendix

## Blooper

## Documenting File Creation 

It's useful to record some information about how your file was created.

- File creation date: 2021-05-03
- File latest updated date: `r today('Asia/Tokyo')`
- `r R.version.string`
- [**rmarkdown** package](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
- File version: 1.0.0
- Author Profile: [¬ÆŒ≥œÉ, Eng Lian Hu](https://github.com/scibrokes/owner)
- GitHub: [Source Code](https://github.com/englianhu/Coursera-Overview-of-Advanced-Methods-of-Reinforcement-Learning-in-Finance)
- Additional session information:

```{r info, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('magrittr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))
suppressMessages(require('knitr', quietly = TRUE))
suppressMessages(require('kableExtra', quietly = TRUE))

sys1 <- devtools::session_info()$platform %>% 
  unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL

sys2 <- data.frame(Sys.info()) %>% 
  dplyr::mutate(Category = rownames(.)) %>% .[2:1]
names(sys2)[2] <- c('Sys.info')
rownames(sys2) <- NULL

if (nrow(sys1) == 9 & nrow(sys2) == 8) {
  sys2 %<>% rbind(., data.frame(
  Category = 'Current time', 
  Sys.info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
} else {
  sys1 %<>% rbind(., data.frame(
  Category = 'Current time', 
  session_info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
}

sys <- cbind(sys1, sys2) %>% 
  kbl(caption = 'Additional session information:') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  row_spec(0, background = 'DimGrey', color = 'yellow') %>% 
  column_spec(1, background = 'CornflowerBlue', color = 'red') %>% 
  column_spec(2, background = 'grey', color = 'black') %>% 
  column_spec(3, background = 'CornflowerBlue', color = 'blue') %>% 
  column_spec(4, background = 'grey', color = 'white') %>% 
  row_spec(9, bold = T, color = 'yellow', background = '#D7261E')

rm(sys1, sys2)
sys
```

## Reference

1) [joelowj/Machine-Learning-and-Reinforcement-Learning-in-Finance](https://github.com/joelowj/Machine-Learning-and-Reinforcement-Learning-in-Finance)
2) [AhmedLabbaali/Reinforcement-Learning-in-Finance-](https://github.com/AhmedLabbaali/Reinforcement-Learning-in-Finance-)
3) [AayushMandhyan/ML-RL-for-Finance](https://github.com/AayushMandhyan/ML-RL-for-Finance)
4) [Ahmed0028/Machine-Learning-and-Reinforcement-Learning-in-Finance-Specialization](https://github.com/Ahmed0028/Machine-Learning-and-Reinforcement-Learning-in-Finance-Specialization)
- [Animate.css](https://animate.style/)
- [Animating CSS Gradients, using only CSS](https://medium.com/@dave_lunny/animating-css-gradients-using-only-css-d2fd7671e759)
- [CLAS Linux Group](https://clas.uiowa.edu/linux/help/applications/rpackage)
- [**quadprogpp**: Fast Quadratic Programming for R](https://github.com/fnoorian/quadprogpp)
- [Econometric estimation of an IRL-based market portfolio model](https://bailiping.github.io/2019-08-04-IRL/)
- [Include HTML files in R Markdown file?](https://stackoverflow.com/a/36525111/3806250)
- [ÈáèÂåñÂàÜÊûê(‰∏â)È†êÊ∏¨Â∏ÇÂ†¥?!](https://medium.com/tej-api-%E9%87%91%E8%9E%8D%E8%B3%87%E6%96%99%E5%88%86%E6%9E%90/%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E4%B8%89-%E9%A0%90%E6%B8%AC%E5%B8%82%E5%A0%B4-bde88352a011)

<br>

---

<br>
